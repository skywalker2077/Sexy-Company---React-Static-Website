name: Deploy to S3

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Build and Deploy to S3
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ðŸ“¦ Install dependencies
      run: npm ci
      
    - name: ðŸ—ï¸ Build application
      run: npm run build
      
    - name: ðŸ“Š Build summary
      run: |
        echo "ðŸ“Š Build completed successfully!"
        echo "ðŸ“ Build directory contents:"
        ls -la build/
        echo ""
        echo "ðŸ“„ Key files:"
        ls -la build/*.html 2>/dev/null || echo "No HTML files found"
        ls -la build/static/ 2>/dev/null || echo "No static directory found"
        
    - name: ðŸ”‘ Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
        
    - name: ðŸª£ Deploy to S3
      run: |
        BUCKET_NAME="sexy-company"
        echo "ðŸš€ Starting deployment to S3 bucket: $BUCKET_NAME"
        echo ""
        
        # Create bucket if it doesn't exist
        if ! aws s3 ls s3://$BUCKET_NAME 2>/dev/null; then
          echo "ðŸ“¦ Creating bucket $BUCKET_NAME..."
          aws s3 mb s3://$BUCKET_NAME --region us-east-1
        else
          echo "âœ… Bucket $BUCKET_NAME already exists"
        fi
        
        # Sync files to S3
        echo "ðŸ“¤ Uploading files to S3..."
        aws s3 sync build/ s3://$BUCKET_NAME --delete
        
        echo "âœ… Files uploaded successfully!"
        
    - name: ðŸŒ Configure website hosting
      run: |
        BUCKET_NAME="sexy-company"
        echo "ðŸŒ Configuring S3 website hosting..."
        
        # Configure website
        aws s3 website s3://$BUCKET_NAME \
          --index-document index.html \
          --error-document index.html
          
        echo "âœ… Website hosting configured!"
        
    - name: ðŸ”“ Configure public access
      run: |
        BUCKET_NAME="sexy-company"
        echo "ðŸ”“ Configuring public access..."
        
        # Remove public access blocks
        aws s3api put-public-access-block \
          --bucket $BUCKET_NAME \
          --public-access-block-configuration \
          BlockPublicAcls=false,IgnorePublicAcls=false,BlockPublicPolicy=false,RestrictPublicBuckets=false
          
        # Create bucket policy
        cat > bucket-policy.json << 'EOF'
        {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "PublicReadGetObject",
              "Effect": "Allow",
              "Principal": "*",
              "Action": "s3:GetObject",
              "Resource": "arn:aws:s3:::sexy-company/*"
            }
          ]
        }
        EOF
        
        # Apply bucket policy
        aws s3api put-bucket-policy --bucket $BUCKET_NAME --policy file://bucket-policy.json
        
        echo "âœ… Public access configured!"
        
    - name: ðŸŽ‰ Deployment complete
      run: |
        BUCKET_NAME="sexy-company"
        echo ""
        echo "ðŸŽ‰ Deployment completed successfully!"
        echo "=================================="
        echo ""
        echo "ðŸŒ Your website is now live at:"
        echo "   Website URL: http://$BUCKET_NAME.s3-website-us-east-1.amazonaws.com"
        echo "   Direct URL:  https://$BUCKET_NAME.s3.amazonaws.com/index.html"
        echo ""
        echo "ðŸ“Š Deployment summary:"
        echo "   âœ… Built React application"
        echo "   âœ… Uploaded to S3 bucket: $BUCKET_NAME"
        echo "   âœ… Configured website hosting"
        echo "   âœ… Enabled public access"
        echo ""
        echo "ðŸš€ Ready to receive visitors!"