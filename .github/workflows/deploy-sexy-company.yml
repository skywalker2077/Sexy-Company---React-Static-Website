name: Deploy to S3 - Sexy Company

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  AWS_REGION: 'us-east-1'
  S3_BUCKET_NAME: 'sexy-company'

jobs:
  deploy-sexy-company:
    name: Deploy to S3 Bucket (sexy-company)
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        echo "ğŸ“¦ Installing dependencies..."
        npm ci
        
    - name: ğŸ—ï¸ Build React application
      run: |
        echo "ğŸ—ï¸ Building React application..."
        npm run build
        
    - name: ğŸ“Š Verify build output
      run: |
        echo "ğŸ“Š Verifying build artifacts..."
        ls -la build/
        
        # Verificar arquivos essenciais
        if [ -f "build/index.html" ]; then
          echo "âœ… index.html found"
        else
          echo "âŒ index.html missing"
          exit 1
        fi
        
        if [ -d "build/static" ]; then
          echo "âœ… static directory found"
          echo "ğŸ“„ Static files:"
          find build/static -type f | head -10
        else
          echo "âŒ static directory missing"
          exit 1
        fi
        
        # Mostrar tamanho do build
        BUILD_SIZE=$(du -sh build/ | cut -f1)
        echo "ğŸ“ Build size: $BUILD_SIZE"
        
    - name: ğŸ”§ Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: ğŸš€ Deploy to S3 (sexy-company bucket)
      run: |
        echo "ğŸš€ Starting deploy to S3 bucket: $S3_BUCKET_NAME"
        
        # Comando principal conforme solicitado
        aws s3 sync build/ s3://$S3_BUCKET_NAME --delete
        
        echo "âœ… Successfully deployed using: aws s3 sync build/ s3://$S3_BUCKET_NAME --delete"
        
    - name: ğŸ”§ Configure S3 bucket for static website hosting
      run: |
        echo "ğŸ”§ Configuring S3 bucket for static website hosting..."
        
        # Configurar website hosting
        aws s3 website s3://$S3_BUCKET_NAME \
          --index-document index.html \
          --error-document index.html
          
        echo "âœ… S3 website hosting configured"
        
    - name: ğŸ”’ Set bucket policy for public access
      run: |
        echo "ğŸ”’ Setting bucket policy for public read access..."
        
        # Criar polÃ­tica de bucket para acesso pÃºblico
        cat > bucket-policy.json << EOF
        {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "PublicReadGetObject",
              "Effect": "Allow",
              "Principal": "*",
              "Action": "s3:GetObject",
              "Resource": "arn:aws:s3:::$S3_BUCKET_NAME/*"
            }
          ]
        }
        EOF
        
        # Aplicar polÃ­tica
        aws s3api put-bucket-policy --bucket $S3_BUCKET_NAME --policy file://bucket-policy.json
        
        echo "âœ… Bucket policy applied successfully"
        
    - name: âš¡ Invalidate CloudFront (if configured)
      run: |
        if [ ! -z "${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}" ]; then
          echo "âš¡ Invalidating CloudFront cache..."
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*"
          echo "âœ… CloudFront cache invalidated"
        else
          echo "â„¹ï¸ No CloudFront distribution ID configured, skipping invalidation"
        fi
        
    - name: ğŸŒ Display deployment URLs
      run: |
        echo "ğŸ‰ Deployment completed successfully!"
        echo ""
        echo "ğŸ“‹ Deployment Summary:"
        echo "====================="
        echo "ğŸª£ S3 Bucket: $S3_BUCKET_NAME"
        echo "ğŸ“¦ Build Size: $(du -sh build/ | cut -f1)"
        echo "ğŸ“… Deployed at: $(date)"
        echo ""
        echo "ğŸŒ Access URLs:"
        echo "â€¢ S3 Website URL: http://$S3_BUCKET_NAME.s3-website-$AWS_REGION.amazonaws.com"
        echo "â€¢ S3 Direct URL: https://$S3_BUCKET_NAME.s3.amazonaws.com/index.html"
        
        if [ ! -z "${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}" ]; then
          echo "â€¢ CloudFront URL: Configure CLOUDFRONT_URL variable for custom domain"
        fi
        
        echo ""
        echo "ğŸ”§ Next steps:"
        echo "1. Test the website using the URLs above"
        echo "2. Configure custom domain (optional)"
        echo "3. Set up CloudFront for better performance (optional)"

  # Job de verificaÃ§Ã£o pÃ³s-deploy
  verify-deployment:
    name: Verify S3 Deployment
    runs-on: ubuntu-latest
    needs: deploy-sexy-company
    if: success()
    
    steps:
    - name: ğŸ” Test S3 website endpoint
      run: |
        S3_WEBSITE_URL="http://sexy-company.s3-website-us-east-1.amazonaws.com"
        
        echo "ğŸ” Testing S3 website endpoint: $S3_WEBSITE_URL"
        
        # Aguardar um momento para propagaÃ§Ã£o
        echo "â³ Waiting for S3 propagation..."
        sleep 10
        
        # Testar se o site estÃ¡ acessÃ­vel
        if curl -f -s -L "$S3_WEBSITE_URL" > /dev/null; then
          echo "âœ… S3 website endpoint is accessible"
          
          # Verificar se contÃ©m o tÃ­tulo correto
          if curl -s -L "$S3_WEBSITE_URL" | grep -q "Sexy Company"; then
            echo "âœ… Website content verification passed"
          else
            echo "âš ï¸ Website content verification failed - title not found"
          fi
          
        else
          echo "âŒ S3 website endpoint is not accessible"
          echo "â„¹ï¸ This might be normal for first deployment - check manually"
        fi
        
    - name: ğŸ“Š Deployment status report
      run: |
        echo "ğŸ“Š Final Deployment Report"
        echo "========================="
        echo "âœ… Build: Success"
        echo "âœ… S3 Upload: Success" 
        echo "âœ… Bucket Configuration: Success"
        echo "âœ… Public Access: Configured"
        echo ""
        echo "ğŸ‰ Sexy Company website deployed successfully!"
        echo ""
        echo "Access your site at:"
        echo "http://sexy-company.s3-website-us-east-1.amazonaws.com"