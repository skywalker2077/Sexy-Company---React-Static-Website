name: Fix S3 Website Configuration

on:
  workflow_dispatch:

jobs:
  fix-website:
    name: Configure S3 Website Hosting
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”§ Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
        
    - name: ğŸŒ Configure S3 Website Hosting
      run: |
        BUCKET_NAME="sexy-company"
        echo "ğŸŒ Configuring S3 website hosting for bucket: $BUCKET_NAME"
        echo ""
        
        # First, check if bucket exists
        if aws s3 ls s3://$BUCKET_NAME 2>/dev/null; then
          echo "âœ… Bucket $BUCKET_NAME exists"
        else
          echo "âŒ Bucket $BUCKET_NAME does not exist"
          exit 1
        fi
        
        echo "ğŸ“‹ Current bucket contents:"
        aws s3 ls s3://$BUCKET_NAME/ --recursive
        echo ""
        
        # Configure website hosting
        echo "ğŸ”§ Configuring website hosting..."
        aws s3 website s3://$BUCKET_NAME \
          --index-document index.html \
          --error-document index.html
        echo "âœ… Website hosting configured"
        
        # Remove public access blocks
        echo "ğŸ”“ Removing public access blocks..."
        aws s3api put-public-access-block \
          --bucket $BUCKET_NAME \
          --public-access-block-configuration \
          BlockPublicAcls=false,IgnorePublicAcls=false,BlockPublicPolicy=false,RestrictPublicBuckets=false
        echo "âœ… Public access blocks removed"
        
        # Create and apply bucket policy
        echo "ğŸ“ Creating bucket policy..."
        cat > bucket-policy.json << 'EOF'
        {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "PublicReadGetObject",
              "Effect": "Allow",
              "Principal": "*",
              "Action": "s3:GetObject",
              "Resource": "arn:aws:s3:::sexy-company/*"
            }
          ]
        }
        EOF
        
        echo "ğŸ”’ Applying bucket policy..."
        aws s3api put-bucket-policy --bucket $BUCKET_NAME --policy file://bucket-policy.json
        echo "âœ… Bucket policy applied"
        
        # Get website configuration to verify
        echo "ğŸ“Š Verifying website configuration..."
        aws s3api get-bucket-website --bucket $BUCKET_NAME || echo "âš ï¸ Website configuration not found"
        
        # Test if index.html exists
        echo "ğŸ“„ Checking if index.html exists..."
        if aws s3api head-object --bucket $BUCKET_NAME --key index.html 2>/dev/null; then
          echo "âœ… index.html found in bucket"
        else
          echo "âŒ index.html not found in bucket"
        fi
        
    - name: ğŸ‰ Website Configuration Complete
      run: |
        BUCKET_NAME="sexy-company"
        echo ""
        echo "ğŸ‰ S3 Website Configuration Complete!"
        echo "====================================="
        echo ""
        echo "ğŸŒ Your website URLs:"
        echo "   Website URL: http://$BUCKET_NAME.s3-website-us-east-1.amazonaws.com"
        echo "   Direct URL:  https://$BUCKET_NAME.s3.amazonaws.com/index.html"
        echo ""
        echo "âœ… Configuration applied:"
        echo "   âœ… Website hosting enabled"
        echo "   âœ… Public access configured"
        echo "   âœ… Bucket policy applied"
        echo "   âœ… Index document: index.html"
        echo ""
        echo "ğŸ” If the website still doesn't work, wait 5-10 minutes for AWS propagation"
        echo "ğŸŒ The website should be accessible worldwide"