name: Simple Secrets Test

on:
  workflow_dispatch:

jobs:
  test-secrets:
    name: Test AWS Secrets
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ” Check secrets configuration
      run: |
        echo "ðŸ” Testing GitHub Secrets..."
        echo ""
        
        # Simple validation without complex bash syntax
        echo "Testing AWS credentials..."
        
    - name: ðŸ”§ Test AWS credentials
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: us-east-1
      run: |
        echo "ðŸ”§ Testing AWS access..."
        
        # Test if credentials work
        if aws sts get-caller-identity; then
          echo ""
          echo "âœ… SUCCESS: AWS credentials are working!"
          echo ""
          
          # Show account info
          echo "ðŸ“‹ AWS Account Information:"
          aws sts get-caller-identity --output table
          echo ""
          
        else
          echo ""
          echo "âŒ FAILED: AWS credentials are not working!"
          echo ""
          echo "Please check:"
          echo "1. AWS_ACCESS_KEY_ID is correct"
          echo "2. AWS_SECRET_ACCESS_KEY is correct" 
          echo "3. The IAM user has necessary permissions"
          exit 1
        fi
        
    - name: ðŸª£ Test S3 bucket access
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: us-east-1
      run: |
        echo "ðŸª£ Testing S3 bucket access..."
        BUCKET_NAME="sexy-company"
        
        # Check if bucket exists and is accessible
        if aws s3 ls s3://$BUCKET_NAME/ >/dev/null 2>&1; then
          echo "âœ… Bucket '$BUCKET_NAME' is accessible"
          
          # Show bucket contents
          echo ""
          echo "ðŸ“„ Current bucket contents:"
          aws s3 ls s3://$BUCKET_NAME/ || echo "   (bucket is empty)"
          echo ""
          
        else
          echo "âš ï¸ Bucket '$BUCKET_NAME' not found or not accessible"
          echo "ðŸ”§ Attempting to create bucket..."
          
          if aws s3 mb s3://$BUCKET_NAME --region us-east-1; then
            echo "âœ… Bucket created successfully!"
          else
            echo "âŒ Failed to create bucket. It might already exist in another account."
            echo "Please check bucket name availability."
          fi
        fi
        
        # Test write permissions
        echo "ðŸ”§ Testing write permissions..."
        echo "test-file-$(date +%s)" > test-file.txt
        
        if aws s3 cp test-file.txt s3://$BUCKET_NAME/test-file.txt; then
          echo "âœ… Write permission: OK"
          
          # Clean up
          aws s3 rm s3://$BUCKET_NAME/test-file.txt
          echo "ðŸ§¹ Test file cleaned up"
          
        else
          echo "âŒ Write permission: FAILED"
          echo "Please check IAM permissions for S3 operations"
          exit 1
        fi
        
    - name: ðŸŒ Configure S3 website hosting
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: us-east-1
      run: |
        echo "ðŸŒ Configuring S3 website hosting..."
        BUCKET_NAME="sexy-company"
        
        # Configure website hosting
        if aws s3 website s3://$BUCKET_NAME \
          --index-document index.html \
          --error-document index.html; then
          echo "âœ… Website hosting configured"
        else
          echo "âš ï¸ Failed to configure website hosting"
        fi
        
        # Set bucket policy for public access
        echo "ðŸ”’ Setting bucket policy for public access..."
        
        cat > bucket-policy.json << 'EOF'
        {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "PublicReadGetObject",
              "Effect": "Allow",
              "Principal": "*",
              "Action": "s3:GetObject",
              "Resource": "arn:aws:s3:::sexy-company/*"
            }
          ]
        }
        EOF
        
        # Remove public access blocks first
        echo "ðŸ”“ Removing public access blocks..."
        aws s3api put-public-access-block \
          --bucket $BUCKET_NAME \
          --public-access-block-configuration \
          BlockPublicAcls=false,IgnorePublicAcls=false,BlockPublicPolicy=false,RestrictPublicBuckets=false \
          || echo "âš ï¸ Could not modify public access blocks"
        
        # Apply bucket policy
        if aws s3api put-bucket-policy --bucket $BUCKET_NAME --policy file://bucket-policy.json; then
          echo "âœ… Bucket policy applied successfully"
        else
          echo "âš ï¸ Failed to apply bucket policy"
        fi
        
    - name: ðŸŽ‰ Test Summary
      run: |
        echo ""
        echo "ðŸŽ‰ GitHub Secrets Validation Complete!"
        echo "====================================="
        echo ""
        echo "âœ… AWS credentials: Working"
        echo "âœ… S3 bucket access: OK"
        echo "âœ… S3 write permissions: OK"
        echo "âœ… Website hosting: Configured"
        echo "âœ… Public access: Configured"
        echo ""
        echo "ðŸŒ Your website will be available at:"
        echo "   http://sexy-company.s3-website-us-east-1.amazonaws.com"
        echo ""
        echo "ðŸš€ Ready for automatic deployment!"
        echo ""
        echo "Next step: Push code to main branch to trigger deployment"