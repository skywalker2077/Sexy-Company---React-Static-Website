name: Continuous Integration

# Workflow mais simples para CI básico
on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  test-and-build:
    name: Test and Build
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4
      
    - name: 🟢 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: 📦 Install dependencies
      run: |
        echo "Installing project dependencies..."
        npm ci
        
    - name: 🔍 Check project structure
      run: |
        echo "Project structure:"
        ls -la
        echo "Package.json scripts:"
        npm run --silent
        
    - name: 🏗️ Build project
      run: |
        echo "Starting build process..."
        npm run build
        echo "Build completed successfully!"
        
    - name: ✅ Verify build output
      run: |
        echo "Verifying build artifacts..."
        if [ -d "build" ]; then
          echo "✅ Build directory exists"
          echo "Build contents:"
          ls -la build/
          
          if [ -f "build/index.html" ]; then
            echo "✅ index.html found"
          else
            echo "❌ index.html not found"
            exit 1
          fi
          
          if [ -d "build/static" ]; then
            echo "✅ Static assets directory found"
            echo "Static files:"
            find build/static -type f -name "*.js" -o -name "*.css" | head -5
          else
            echo "❌ Static assets directory not found"
            exit 1
          fi
          
          # Verificar tamanho do build
          BUILD_SIZE=$(du -sh build/ | cut -f1)
          echo "📏 Build size: $BUILD_SIZE"
          
        else
          echo "❌ Build directory not found"
          exit 1
        fi
        
        echo "🎉 All build verifications passed!"

  # Job para verificar se não há vulnerabilidades críticas
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4
      
    - name: 🟢 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: 📦 Install dependencies
      run: npm ci
      
    - name: 🔒 Run security audit
      run: |
        echo "Running security audit..."
        npm audit --audit-level high
      continue-on-error: true